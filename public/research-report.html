<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>التقرير البحثي - مشروع نظام LMS المتكامل</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', 'Tahoma', 'Geneva', 'Verdana', sans-serif;
        }
        
        body {
            background: #f5f7fa;
            color: #333;
            line-height: 1.6;
        }
        /* تنسيق الطباعة */
        
        @media print {
            body {
                background: white;
                font-size: 12pt;
            }
            .no-print {
                display: none !important;
            }
            .page-break {
                page-break-before: always;
            }
            .report-content {
                box-shadow: none !important;
                padding: 0 !important;
            }
            .privacy-banner {
                background: white !important;
                color: black !important;
                border: 1px solid #ddd !important;
            }
        }
        
        .container {
            max-width: 210mm;
            margin: 0 auto;
            padding: 20px;
        }
        /* أزرار التحكم */
        
        .control-bar {
            background: linear-gradient(135deg, #1a2980 0%, #26d0ce 100%);
            color: white;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }
        
        .control-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .control-btn {
            padding: 10px 20px;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 5px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s ease;
        }
        
        .control-btn:hover {
            background: rgba(255, 255, 255, 0.2);
        }
        
        .control-btn.print {
            background: #2ecc71;
        }
        
        .control-btn.pdf {
            background: #e74c3c;
        }
        /* شريط الخصوصية */
        
        .privacy-banner {
            background: linear-gradient(135deg, #9b59b6, #8e44ad);
            color: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 25px;
            display: flex;
            align-items: center;
            gap: 20px;
            flex-wrap: wrap;
        }
        
        .privacy-icon {
            font-size: 2.5em;
        }
        
        .privacy-info h3 {
            margin-bottom: 5px;
            font-size: 1.3em;
        }
        
        .privacy-stats {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
            margin-top: 10px;
        }
        
        .privacy-stat {
            text-align: center;
        }
        
        .privacy-number {
            font-size: 2em;
            font-weight: bold;
            display: block;
        }
        
        .privacy-label {
            font-size: 0.9em;
            opacity: 0.9;
        }
        /* محتوى التقرير */
        
        .report-content {
            background: white;
            padding: 40px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            border-radius: 10px;
        }
        /* صفحة الغلاف */
        
        .cover-page {
            text-align: center;
            padding: 50px 0;
            border-bottom: 3px solid #1a2980;
            margin-bottom: 40px;
        }
        
        .university-logo {
            font-size: 4em;
            color: #1a2980;
            margin-bottom: 20px;
        }
        
        .cover-page h1 {
            font-size: 2.5em;
            color: #1a2980;
            margin-bottom: 20px;
            line-height: 1.3;
        }
        
        .cover-page h2 {
            font-size: 1.8em;
            color: #2c3e50;
            margin-bottom: 30px;
        }
        
        .project-team {
            margin: 40px 0;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
            max-width: 600px;
            margin-left: auto;
            margin-right: auto;
        }
        /* أقسام التقرير */
        
        .report-section {
            margin-bottom: 40px;
            padding-bottom: 30px;
            border-bottom: 1px solid #eee;
        }
        
        .section-title {
            color: #1a2980;
            font-size: 1.8em;
            margin-bottom: 25px;
            padding-bottom: 10px;
            border-bottom: 2px solid #26d0ce;
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .section-title i {
            color: #26d0ce;
        }
        
        .subsection-title {
            color: #2c3e50;
            font-size: 1.4em;
            margin: 25px 0 15px 0;
            padding-right: 15px;
            border-right: 3px solid #3498db;
        }
        /* الجداول */
        
        .report-table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
            font-size: 0.95em;
        }
        
        .report-table th {
            background: #f8f9fa;
            padding: 12px;
            text-align: right;
            border: 1px solid #ddd;
            font-weight: 600;
            color: #2c3e50;
        }
        
        .report-table td {
            padding: 12px;
            border: 1px solid #ddd;
            text-align: right;
        }
        
        .report-table tr:nth-child(even) {
            background: #f8f9fa;
        }
        /* الرسوم البيانية */
        
        .chart-placeholder {
            background: #f8f9fa;
            border: 2px dashed #ddd;
            padding: 40px;
            text-align: center;
            margin: 20px 0;
            border-radius: 10px;
            color: #666;
        }
        /* القوائم */
        
        .feature-list {
            list-style-type: none;
            padding-right: 0;
        }
        
        .feature-list li {
            padding: 10px;
            margin-bottom: 10px;
            background: #f8f9fa;
            border-right: 4px solid #3498db;
            border-radius: 5px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .feature-list li i {
            color: #2ecc71;
        }
        /* الإحصائيات */
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin: 25px 0;
        }
        
        .stat-box {
            text-align: center;
            padding: 20px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border-radius: 10px;
        }
        
        .stat-number {
            font-size: 2.5em;
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .stat-label {
            font-size: 0.9em;
            opacity: 0.9;
        }
        /* التوصيات */
        
        .recommendations {
            background: #e8f4fc;
            padding: 25px;
            border-radius: 10px;
            margin: 25px 0;
            border-right: 5px solid #3498db;
        }
        
        .recommendation-item {
            margin-bottom: 15px;
            padding-right: 15px;
            position: relative;
        }
        
        .recommendation-item:before {
            content: "•";
            color: #3498db;
            font-size: 1.5em;
            position: absolute;
            right: -5px;
        }
        /* ملاحظات الخصوصية */
        
        .privacy-notes {
            background: #f9f0ff;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
            border-right: 4px solid #9b59b6;
        }
        /* الفوتر */
        
        .report-footer {
            text-align: center;
            margin-top: 50px;
            padding-top: 20px;
            border-top: 2px solid #eee;
            color: #666;
            font-size: 0.9em;
        }
        /* التحميل */
        
        .loading {
            text-align: center;
            padding: 50px;
            color: #666;
        }
        
        .loading i {
            font-size: 2em;
            margin-bottom: 15px;
            color: #3498db;
        }
        /* متجاوب */
        
        @media (max-width: 768px) {
            .report-content {
                padding: 20px;
            }
            .control-bar {
                flex-direction: column;
                text-align: center;
            }
            .control-buttons {
                justify-content: center;
            }
            .section-title {
                font-size: 1.5em;
            }
            .cover-page h1 {
                font-size: 2em;
            }
            .privacy-banner {
                flex-direction: column;
                text-align: center;
            }
        }
    </style>
</head>

<body>
    <div class="container">
        <!-- شريط التحكم -->
        <div class="control-bar no-print">
            <div>
                <h3 style="margin: 0;"><i class="fas fa-file-alt"></i> التقرير البحثي - النسخة الإلكترونية</h3>
                <p style="margin: 5px 0 0 0; opacity: 0.9; font-size: 0.9em;">آخر تحديث: <span id="lastUpdate"></span></p>
            </div>
            <div class="control-buttons">
                <button class="control-btn" onclick="window.print()">
                    <i class="fas fa-print"></i> طباعة
                </button>
                <button class="control-btn pdf" onclick="exportPDF()">
                    <i class="fas fa-file-pdf"></i> تصدير PDF
                </button>
                <button class="control-btn" onclick="window.location.href='/dashboard'">
                    <i class="fas fa-chart-line"></i> لوحة التحكم
                </button>
                <button class="control-btn" onclick="window.location.href='/'">
                    <i class="fas fa-home"></i> الرئيسية
                </button>
            </div>
        </div>

        <!-- شريط الخصوصية -->
        <div class="privacy-banner">
            <div class="privacy-icon">
                <i class="fas fa-shield-alt"></i>
            </div>
            <div class="privacy-info">
                <h3>نظام خصوصية متقدم</h3>
                <p>جميع البيانات مجهولة المصدر لحماية خصوصية المشاركين</p>
                <div class="privacy-stats" id="privacyStats">
                    <!-- سيتم ملؤها بالجافاسكريبت -->
                </div>
            </div>
        </div>

        <!-- محتوى التقرير -->
        <div class="report-content" id="reportContent">
            <!-- صفحة الغلاف -->
            <div class="cover-page">
                <div class="university-logo">
                    <i class="fas fa-university"></i>
                </div>
                <h1>تقرير البحث العلمي</h1>
                <h2>دراسة استطلاعية لمشروع نظام إدارة التعلم الإلكتروني المتكامل (LMS)</h2>

                <div class="project-team">
                    <h3 style="color: #1a2980; margin-bottom: 15px;">فريق البحث</h3>
                    <p><strong>الباحث الرئيسي:</strong> عبدالله سالم الحليمي</p>
                    <p><strong>المشرف الأكاديمي:</strong> د. أحمد</p>
                    <p><strong>جامعة الملك سعود - كلية علوم الحاسب والمعلومات</strong></p>
                </div>

                <div style="margin-top: 40px;">
                    <p><strong>تاريخ النشر:</strong> <span id="reportDate"></span></p>
                    <p><strong>عدد الصفحات:</strong> <span id="pageCount">--</span></p>
                    <p><strong>الإصدار:</strong> 3.0 (نظام خصوصية متقدم)</p>
                </div>
            </div>

            <!-- الفهرس -->
            <div class="report-section">
                <h2 class="section-title"><i class="fas fa-list"></i> فهرس المحتويات</h2>
                <div id="tableOfContents">
                    <!-- سيتم ملؤها بالجافاسكريبت -->
                </div>
            </div>

            <!-- الملخص التنفيذي -->
            <div class="report-section">
                <h2 class="section-title"><i class="fas fa-file-signature"></i> الملخص التنفيذي</h2>
                <div id="executiveSummary">
                    <div class="loading">
                        <i class="fas fa-spinner fa-spin"></i> جاري تحميل البيانات...
                    </div>
                </div>
            </div>

            <!-- منهجية البحث -->
            <div class="report-section">
                <h2 class="section-title"><i class="fas fa-flask"></i> منهجية البحث</h2>

                <h3 class="subsection-title">نظام الخصوصية المتبع</h3>
                <div class="privacy-notes">
                    <p><strong>تم تصميم نظام البحث على أساس مبادئ الخصوصية التالية:</strong></p>
                    <ul class="feature-list" style="margin-top: 15px;">
                        <li><i class="fas fa-user-secret"></i> جميع المعلومات الشخصية <strong>اختيارية</strong></li>
                        <li><i class="fas fa-ban"></i> لا يطلب النظام بريداً إلكترونياً أو أرقام هواتف</li>
                        <li><i class="fas fa-mask"></i> المشاركة المجهولة متاحة للجميع</li>
                        <li><i class="fas fa-lock"></i> البيانات مشفرة ومجهولة المصدر</li>
                        <li><i class="fas fa-chart-bar"></i> التحليل الإحصائي يعتمد على بيانات مجمعة</li>
                    </ul>
                </div>

                <h3 class="subsection-title">مجتمع البحث وعينة الدراسة</h3>
                <div id="researchMethodology">
                    <!-- سيتم ملؤها بالجافاسكريبت -->
                </div>

                <h3 class="subsection-title">أدوات جمع البيانات</h3>
                <ul class="feature-list">
                    <li><i class="fas fa-check-circle"></i> استبيان إلكتروني للطلاب (نظام خصوصية متقدم)</li>
                    <li><i class="fas fa-check-circle"></i> استبيان إلكتروني للهيئة التدريسية (نظام خصوصية متقدم)</li>
                    <li><i class="fas fa-check-circle"></i> نظام جمع بيانات تلقائي مع حماية الخصوصية</li>
                    <li><i class="fas fa-check-circle"></i> تحليل إحصائي آلي للنتائج المجهولة</li>
                </ul>

                <h3 class="subsection-title">فترة جمع البيانات</h3>
                <p>تم جمع البيانات خلال الفترة من <span id="dataCollectionPeriod"></span>، بواسطة النظام الإلكتروني المطور خصيصاً للبحث مع التركيز على حماية خصوصية المشاركين.</p>
            </div>

            <!-- النتائج والإحصائيات -->
            <div class="report-section">
                <h2 class="section-title"><i class="fas fa-chart-bar"></i> النتائج والإحصائيات</h2>

                <h3 class="subsection-title">الإحصائيات العامة</h3>
                <div class="stats-grid" id="generalStats">
                    <!-- سيتم ملؤها بالجافاسكريبت -->
                </div>

                <h3 class="subsection-title">تحليل بيانات الطلاب</h3>
                <div id="studentsAnalysis">
                    <!-- سيتم ملؤها بالجافاسكريبت -->
                </div>

                <h3 class="subsection-title">تحليل بيانات الهيئة التدريسية</h3>
                <div id="professorsAnalysis">
                    <!-- سيتم ملؤها بالجافاسكريبت -->
                </div>

                <h3 class="subsection-title">الرسوم البيانية</h3>
                <div class="chart-placeholder">
                    <i class="fas fa-chart-pie" style="font-size: 2em; margin-bottom: 15px;"></i>
                    <p>الرسوم البيانية التفاعلية متاحة في <a href="/dashboard" style="color: #3498db;">لوحة التحكم</a></p>
                    <p>يمكن تصديرها كصور للاستخدام في العرض التقديمي</p>
                </div>
            </div>

            <!-- تحليل الميزات -->
            <div class="report-section">
                <h2 class="section-title"><i class="fas fa-star"></i> تحليل الميزات المقترحة</h2>

                <table class="report-table">
                    <thead>
                        <tr>
                            <th>الميزة</th>
                            <th>متوسط الأهمية (1-5)</th>
                            <th>ترتيب الأولوية</th>
                            <th>ملاحظات</th>
                        </tr>
                    </thead>
                    <tbody id="featuresAnalysis">
                        <!-- سيتم ملؤها بالجافاسكريبت -->
                    </tbody>
                </table>
            </div>

            <!-- التحديات والمشاكل -->
            <div class="report-section">
                <h2 class="section-title"><i class="fas fa-exclamation-triangle"></i> التحديات والمشاكل المحددة</h2>

                <div id="challengesAnalysis">
                    <!-- سيتم ملؤها بالجافاسكريبت -->
                </div>

                <h3 class="subsection-title">المشاكل التقنية الشائعة</h3>
                <ul class="feature-list" id="technicalProblems">
                    <!-- سيتم ملؤها بالجافاسكريبت -->
                </ul>
            </div>

            <!-- التوصيات والمقترحات -->
            <div class="report-section">
                <h2 class="section-title"><i class="fas fa-lightbulb"></i> التوصيات والمقترحات</h2>

                <div class="recommendations">
                    <h3 style="color: #1a2980; margin-bottom: 20px;">التوصيات الرئيسية</h3>
                    <div id="mainRecommendations">
                        <!-- سيتم ملؤها بالجافاسكريبت -->
                    </div>
                </div>

                <h3 class="subsection-title">خطوات التنفيذ المقترحة</h3>
                <ol style="padding-right: 25px; margin: 20px 0;" id="implementationSteps">
                    <!-- سيتم ملؤها بالجافاسكريبت -->
                </ol>
            </div>

            <!-- الخاتمة -->
            <div class="report-section">
                <h2 class="section-title"><i class="fas fa-flag-checkered"></i> الخاتمة</h2>
                <div id="conclusion">
                    <!-- سيتم ملؤها بالجافاسكريبت -->
                </div>
            </div>

            <!-- المراجع -->
            <div class="report-section">
                <h2 class="section-title"><i class="fas fa-book"></i> المراجع</h2>
                <ol style="padding-right: 25px;">
                    <li>Ally, M. (2019). The Impact of Learning Management Systems on Student Success</li>
                    <li>Clark, R. C., & Mayer, R. E. (2016). E-learning and the Science of Instruction</li>
                    <li>GDPR (2018). General Data Protection Regulation - Privacy by Design</li>
                    <li>جامعة الملك سعود (2023). تقرير التعليم الإلكتروني السنوي</li>
                    <li>وزارة التعليم (2023). دليل حماية البيانات في البحث العلمي</li>
                </ol>
            </div>

            <!-- الفوتر -->
            <div class="report-footer">
                <p>© 2024 جامعة الملك سعود - كلية علوم الحاسب والمعلومات</p>
                <p>هذا التقرير جزء من مشروع تخرج في برنامج علوم الحاسب</p>
                <p>جميع الحقوق محفوظة - للاستخدام الأكاديمي فقط</p>
                <p>تقرير رقم: LMS-RES-2024-001-PRIVACY</p>
                <p style="margin-top: 10px; color: #9b59b6;">
                    <i class="fas fa-shield-alt"></i> تم إعداد هذا التقرير بنظام خصوصية متقدم
                </p>
            </div>
        </div>
    </div>

    <script>
        // تحميل البيانات وإنشاء التقرير
        async function generateReport() {
            try {
                const [dataResponse, analysisResponse, anonymousResponse] = await Promise.all([
                    fetch('/api/data/all'),
                    fetch('/api/analysis'),
                    fetch('/api/stats/anonymous')
                ]);

                const data = await dataResponse.json();
                const analysis = await analysisResponse.json();
                const anonymousStats = await anonymousResponse.json();

                updateReportDates();
                generateTableOfContents();
                generateExecutiveSummary(data, analysis, anonymousStats);
                generateResearchMethodology(data, anonymousStats);
                generateGeneralStats(data, anonymousStats);
                generateStudentsAnalysis(data);
                generateProfessorsAnalysis(data);
                generateFeaturesAnalysis(analysis);
                generateChallengesAnalysis(analysis);
                generateRecommendations(analysis);
                generateConclusion(data, analysis);
                updatePrivacyStats(anonymousStats);
                calculatePageCount();
            } catch (error) {
                console.error('Error generating report:', error);
                document.getElementById('executiveSummary').innerHTML =
                    '<p style="color: #e74c3c;">حدث خطأ في تحميل البيانات. يرجى المحاولة مرة أخرى.</p>';
            }
        }

        // تحديث التواريخ
        function updateReportDates() {
            const now = new Date();
            const hijriDate = now.toLocaleDateString('ar-SA', {
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });

            document.getElementById('reportDate').textContent = hijriDate;
            document.getElementById('lastUpdate').textContent = hijriDate + ' ' + now.toLocaleTimeString('ar-SA');

            // فترة جمع البيانات (آخر 30 يوم)
            const endDate = new Date();
            const startDate = new Date();
            startDate.setDate(startDate.getDate() - 30);

            document.getElementById('dataCollectionPeriod').textContent =
                startDate.toLocaleDateString('ar-SA') + ' - ' + endDate.toLocaleDateString('ar-SA');
        }

        // تحديث إحصائيات الخصوصية
        function updatePrivacyStats(anonymousStats) {
            const privacyStats = document.getElementById('privacyStats');
            privacyStats.innerHTML = `
                <div class="privacy-stat">
                    <span class="privacy-number">${anonymousStats.totalAnonymous || 0}</span>
                    <span class="privacy-label">مشارك مجهول</span>
                </div>
                <div class="privacy-stat">
                    <span class="privacy-number">${anonymousStats.anonymousPercentage || 0}%</span>
                    <span class="privacy-label">نسبة الخصوصية</span>
                </div>
                <div class="privacy-stat">
                    <span class="privacy-number">${anonymousStats.totalParticipants || 0}</span>
                    <span class="privacy-label">إجمالي المشاركين</span>
                </div>
            `;
        }

        // إنشاء الفهرس
        function generateTableOfContents() {
            const sections = [{
                title: 'الملخص التنفيذي',
                id: 'executiveSummary'
            }, {
                title: 'منهجية البحث',
                id: 'researchMethodology'
            }, {
                title: 'النتائج والإحصائيات',
                id: 'generalStats'
            }, {
                title: 'تحليل الميزات المقترحة',
                id: 'featuresAnalysis'
            }, {
                title: 'التحديات والمشاكل المحددة',
                id: 'challengesAnalysis'
            }, {
                title: 'التوصيات والمقترحات',
                id: 'mainRecommendations'
            }, {
                title: 'الخاتمة',
                id: 'conclusion'
            }];

            const tocHTML = sections.map((section, index) => `
                <div style="margin-bottom: 10px; padding-right: 20px;">
                    <a href="#${section.id}" style="color: #3498db; text-decoration: none;">
                        ${index + 1}. ${section.title}
                    </a>
                </div>
            `).join('');

            document.getElementById('tableOfContents').innerHTML = tocHTML;
        }

        // إنشاء الملخص التنفيذي
        function generateExecutiveSummary(data, analysis, anonymousStats) {
            const totalParticipants = data.totals.total;
            const anonymousPercentage = anonymousStats.anonymousPercentage || 0;
            const positiveFeedback = calculatePositiveFeedback(analysis);
            const topFeature = getTopFeature(analysis);

            const summary = `
                <p>يهدف هذا البحث إلى دراسة جدوى وتقييم احتياجات نظام إدارة تعلم إلكتروني متكامل (LMS) 
                يلبي متطلبات العملية التعليمية الحديثة مع التركيز على <strong>خصوصية المشاركين</strong> 
                وجودة البيانات البحثية.</p>
                
                <p>تم جمع البيانات من <strong>${totalParticipants}</strong> مشاركاً 
                باستخدام نظام خصوصية متقدم، حيث شارك <strong>${anonymousPercentage}%</strong> 
                من المشاركين بشكل مجهول، مما يدل على نجاح النظام في تشجيع المشاركة الصادقة 
                وحماية هوية المشاركين.</p>
                
                <p>أظهرت النتائج أن <strong>${positiveFeedback}%</strong> من المشاركين أعربوا عن رضا إيجابي 
                عن فكرة النظام المقترح، مع تأكيد أهمية الميزات المتقدمة مثل نظام المراقبة الذكية 
                والتحضير الآلي.</p>
                
                <p>تم تحديد <strong>"${topFeature}"</strong> كأهم ميزة مطلوبة من قبل المستخدمين، 
                مما يدل على الحاجة الملحة لنظام متكامل يحل مشاكل التعليم الإلكتروني الحالية 
                مع الحفاظ على خصوصية المستخدمين.</p>
                
                <p>يخلص البحث إلى جدوى تطبيق النظام المقترح مع تقديم توصيات عملية لضمان نجاح 
                التطبيق والاستفادة القصوى من ميزاته المتقدمة، مع التأكيد على أهمية استمرار 
                حماية خصوصية المستخدمين في جميع مراحل التطوير.</p>
            `;

            document.getElementById('executiveSummary').innerHTML = summary;
        }

        function calculatePositiveFeedback(analysis) {
            const satisfaction = analysis.charts.satisfactionLevels || {};
            const total = Object.values(satisfaction).reduce((a, b) => a + b, 0);
            const positive = (satisfaction['مرتفع جداً'] || 0) + (satisfaction['مرتفع'] || 0);
            return total > 0 ? ((positive / total) * 100).toFixed(1) : 0;
        }

        function getTopFeature(analysis) {
            const features = analysis.charts.featureRankings || {};
            const topFeature = Object.entries(features).sort(([, a], [, b]) => b - a)[0];
            return topFeature ? topFeature[0] : 'نظام مراقبة الاختبارات';
        }

        // إنشاء منهجية البحث
        function generateResearchMethodology(data, anonymousStats) {
            const methodology = `
                <p>اعتمد البحث على المنهج الوصفي التحليلي، مع التركيز على <strong>خصوصية المشاركين</strong> 
                وجودة البيانات المجمعة. تم تصميم أداتين رئيسيتين لجمع البيانات مع نظام خصوصية متقدم:</p>
                
                <div class="stats-grid" style="margin: 20px 0;">
                    <div class="stat-box">
                        <div class="stat-number">${data.totals.students}</div>
                        <div class="stat-label">طالب</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-number">${data.totals.professors}</div>
                        <div class="stat-label">عضو هيئة تدريس</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-number">${data.totals.total}</div>
                        <div class="stat-label">إجمالي المشاركين</div>
                    </div>
                    <div class="stat-box" style="background: linear-gradient(135deg, #9b59b6, #8e44ad);">
                        <div class="stat-number">${anonymousStats.anonymousPercentage || 0}%</div>
                        <div class="stat-label">مشاركة مجهولة</div>
                    </div>
                </div>
                
                <p>تم اختيار العينة عشوائياً من مجتمع البحث الذي يشمل طلاب وهيئة تدريسية في 
                جامعة الملك سعود وعدد من الجامعات السعودية الأخرى، مع ضمان <strong>سرية البيانات</strong> 
                و<strong>حماية هوية المشاركين</strong>.</p>
            `;

            document.getElementById('researchMethodology').innerHTML = methodology;
        }

        // إنشاء الإحصائيات العامة
        function generateGeneralStats(data, anonymousStats) {
            const stats = `
                <div class="stats-grid">
                    <div class="stat-box">
                        <div class="stat-number">${data.totals.total}</div>
                        <div class="stat-label">إجمالي المشاركين</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-number">${data.totals.students}</div>
                        <div class="stat-label">عدد الطلاب</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-number">${data.totals.professors}</div>
                        <div class="stat-label">عدد الهيئة التدريسية</div>
                    </div>
                    <div class="stat-box" style="background: linear-gradient(135deg, #9b59b6, #8e44ad);">
                        <div class="stat-number">${anonymousStats.totalAnonymous || 0}</div>
                        <div class="stat-label">مشاركة مجهولة</div>
                    </div>
                </div>
            `;

            document.getElementById('generalStats').innerHTML = stats;
        }

        // إنشاء تحليل بيانات الطلاب
        function generateStudentsAnalysis(data) {
            const students = data.students;
            const majorDistribution = students.reduce((acc, student) => {
                const major = student.major || 'غير محدد';
                acc[major] = (acc[major] || 0) + 1;
                return acc;
            }, {});

            const topMajor = Object.entries(majorDistribution).sort(([, a], [, b]) => b - a)[0] || ['غير محدد', 0];
            const anonymousStudents = students.filter(s => s.participationType === 'anonymous').length;

            const analysis = `
                <p>يشكل الطلاب <strong>${((data.totals.students / data.totals.total) * 100).toFixed(1)}%</strong> 
                من عينة الدراسة، منهم <strong>${anonymousStudents}</strong> مشاركاً (<strong>${((anonymousStudents / data.totals.students) * 100).toFixed(1)}%</strong>) 
                شاركوا بشكل مجهول.</p>
                
                <p>تمثل تخصص <strong>${topMajor[0]}</strong> النسبة الأكبر بنسبة 
                <strong>${((topMajor[1] / data.totals.students) * 100).toFixed(1)}%</strong>.</p>
                
                <p>أظهرت نتائج استبيان الطلاب اهتماماً كبيراً بميزات النظام المقترح، خاصة:</p>
                
                <ul class="feature-list">
                    <li><i class="fas fa-check-circle"></i> نظام التحضير الآلي (تفضيل QR Code)</li>
                    <li><i class="fas fa-check-circle"></i> إمكانية العمل بدون إنترنت</li>
                    <li><i class="fas fa-check-circle"></i> سرعة الحصول على نتائج الاختبارات</li>
                    <li><i class="fas fa-check-circle"></i> خصوصية البيانات والحماية</li>
                </ul>
            `;

            document.getElementById('studentsAnalysis').innerHTML = analysis;
        }

        // إنشاء تحليل بيانات الهيئة التدريسية
        function generateProfessorsAnalysis(data) {
            const professors = data.professors;
            const experienceDistribution = professors.reduce((acc, prof) => {
                const exp = prof.teachingExperience || 'غير محدد';
                acc[exp] = (acc[exp] || 0) + 1;
                return acc;
            }, {});

            const topExperience = Object.entries(experienceDistribution).sort(([, a], [, b]) => b - a)[0] || ['غير محدد', 0];
            const anonymousProfessors = professors.filter(p => p.participationType === 'anonymous').length;

            const analysis = `
                <p>تمثل الهيئة التدريسية <strong>${((data.totals.professors / data.totals.total) * 100).toFixed(1)}%</strong> 
                من عينة الدراسة، منهم <strong>${anonymousProfessors}</strong> مشاركاً (<strong>${((anonymousProfessors / data.totals.professors) * 100).toFixed(1)}%</strong>) 
                شاركوا بشكل مجهول.</p>
                
                <p><strong>${topExperience[1]}</strong> مشاركاً لديهم خبرة 
                <strong>${topExperience[0]}</strong> في التدريس.</p>
                
                <p>ركزت اهتمامات الهيئة التدريسية على:</p>
                
                <ul class="feature-list">
                    <li><i class="fas fa-check-circle"></i> نظام مراقبة الاختبارات لمكافحة الغش</li>
                    <li><i class="fas fa-check-circle"></i> تقارير تحليلية مفصلة لأداء الطلاب</li>
                    <li><i class="fas fa-check-circle"></i> سهولة إدارة المحتوى التعليمي</li>
                    <li><i class="fas fa-check-circle"></i> خصوصية بيانات الطلاب والمدرسين</li>
                </ul>
            `;

            document.getElementById('professorsAnalysis').innerHTML = analysis;
        }

        // إنشاء تحليل الميزات
        function generateFeaturesAnalysis(analysis) {
            const features = analysis.charts.featureRankings || {};
            const sortedFeatures = Object.entries(features)
                .sort(([, a], [, b]) => b - a)
                .slice(0, 5);

            const featuresHTML = sortedFeatures.map(([feature, rating], index) => `
                <tr>
                    <td>${feature}</td>
                    <td>${rating}</td>
                    <td>${index + 1}</td>
                    <td>${getFeatureNotes(feature)}</td>
                </tr>
            `).join('');

            document.getElementById('featuresAnalysis').innerHTML = featuresHTML;
        }

        function getFeatureNotes(feature) {
            const notes = {
                'نظام مراقبة الاختبارات': 'أهمية عالية لمكافحة الغش مع الحفاظ على الخصوصية',
                'نظام التحضير الآلي': 'يقلل من الوقت المهدر ويسهل العملية',
                'إدارة المحاضرات': 'تحسين تجربة التعلم عن بعد',
                'نظام الاختبارات الإلكترونية': 'تقييم فوري وفعال مع حماية البيانات',
                'إدارة الأنشطة': 'متابعة مستمرة لأداء الطلاب'
            };

            return notes[feature] || 'ميزة أساسية في النظام مع مراعاة الخصوصية';
        }

        // إنشاء تحليل التحديات
        function generateChallengesAnalysis(analysis) {
            const challenges = analysis.insights || [];

            const challengesHTML = challenges.length > 0 ? challenges.map(challenge => `
                <p style="margin-bottom: 10px; padding-right: 15px; border-right: 3px solid #f1c40f;">
                    <i class="fas fa-exclamation-circle" style="color: #f1c40f; margin-left: 10px;"></i>
                    ${challenge}
                </p>
            `).join('') : '<p>لا توجد تحديات محددة في البيانات الحالية.</p>';

            document.getElementById('challengesAnalysis').innerHTML = challengesHTML;

            // المشاكل التقنية
            const techProblems = [
                'ضعف الإنترنت في بعض المناطق',
                'مشاكل في كاميرات الأجهزة المحمولة',
                'صعوبة التعامل مع الأنظمة التقنية',
                'نقص التدريب الكافي',
                'مخاوف خصوصية البيانات'
            ];

            const problemsHTML = techProblems.map(problem => `
                <li><i class="fas fa-wrench"></i> ${problem}</li>
            `).join('');

            document.getElementById('technicalProblems').innerHTML = problemsHTML;
        }

        // إنشاء التوصيات
        function generateRecommendations(analysis) {
            const recommendations = `
                <div class="recommendation-item">تطوير نظام مراقبة متقدم للاختبارات العملية مع الحفاظ على خصوصية الطلاب</div>
                <div class="recommendation-item">توفير نظام يعمل بدون إنترنت للطلاب في المناطق النائية</div>
                <div class="recommendation-item">تدريب الهيئة التدريسية على استخدام النظام الجديد مع التركيز على الخصوصية</div>
                <div class="recommendation-item">تطوير تطبيق محمول سهل الاستخدام مع إعدادات خصوصية متقدمة</div>
                <div class="recommendation-item">إنشاء مركز دعم فني متخصص في حماية البيانات والخصوصية</div>
                <div class="recommendation-item">تطبيق مبدأ "الخصوصية منذ التصميم" في جميع مراحل التطوير</div>
            `;

            document.getElementById('mainRecommendations').innerHTML = recommendations;

            // خطوات التنفيذ
            const steps = `
                <li>إعداد البنية التحتية التقنية مع نظام أمان وخصوصية متقدم</li>
                <li>تطوير النموذج الأولي (Prototype) مع اختبارات الخصوصية</li>
                <li>اختبار النظام مع مجموعة مستخدمين محدودة مع ضمان الخصوصية</li>
                <li>تحليل نتائج الاختبار وإجراء التحسينات اللازمة</li>
                <li>التدريب الشامل للمستخدمين على الخصوصية وحماية البيانات</li>
                <li>التطبيق الكامل على مستوى المؤسسة التعليمية مع المراجعة الدورية</li>
            `;

            document.getElementById('implementationSteps').innerHTML = steps;
        }

        // إنشاء الخاتمة
        function generateConclusion(data, analysis) {
            const anonymousStats = analysis.summary || {};
            const anonymousPercentage = anonymousStats.anonymousPercentage || 0;

            const conclusion = `
                <p>يؤكد هذا البحث على الحاجة الملحة لنظام إدارة تعلم إلكتروني متكامل 
                يحل المشاكل التقليدية في التعليم الإلكتروني مع الحفاظ على <strong>خصوصية المستخدمين</strong> 
                وجودة البيانات البحثية.</p>
                
                <p>النظام المقترح حصل على قبول عالٍ من جميع فئات المستخدمين، حيث شارك 
                <strong>${data.totals.total}</strong> فرداً في الدراسة، بنسبة خصوصية بلغت 
                <strong>${anonymousPercentage}%</strong>، مما يدل على نجاح نظام الخصوصية 
                في تشجيع المشاركة الصادقة وحماية هوية المشاركين.</p>
                
                <p>يمكن اعتماد نتائج هذا البحث كأساس علمي لتطوير النظام المقترح، 
                مع التأكيد على أهمية استمرار التركيز على <strong>حماية البيانات</strong> 
                و<strong>خصوصية المستخدمين</strong> في جميع مراحل التطوير.</p>
                
                <p style="font-weight: bold; color: #1a2980; margin-top: 20px;">
                    هذا النظام ليس مجرد أداة تقنية، بل هو نقلة نوعية في تجربة التعليم الإلكتروني
                    تساهم في رفع جودة المخرجات التعليمية ومواكبة متطلبات العصر الرقمي،
                    مع الحفاظ على المبادئ الأساسية للخصوصية وحماية البيانات.
                </p>
            `;

            document.getElementById('conclusion').innerHTML = conclusion;
        }

        // حساب عدد الصفحات
        function calculatePageCount() {
            const contentHeight = document.getElementById('reportContent').scrollHeight;
            const pageHeight = 297; // A4 height in mm
            const pageCount = Math.ceil(contentHeight / (pageHeight * 3.78)); // Convert pixels to mm

            document.getElementById('pageCount').textContent = pageCount;
        }

        // تصدير PDF
        function exportPDF() {
            alert('ميزة تصدير PDF قيد التطوير. استخدم زر الطباعة لحفظ التقرير كـ PDF.');
            window.print();
        }

        // تحميل التقرير عند فتح الصفحة
        window.onload = function() {
            generateReport();

            // تحديث عدد الصفحات بعد تحميل المحتوى
            setTimeout(calculatePageCount, 1000);
        };
    </script>
</body>

</html>